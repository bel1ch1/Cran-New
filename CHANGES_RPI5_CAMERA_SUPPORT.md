# Изменения: Расширенная поддержка камер для Raspberry Pi 5

## Обзор

Добавлена поддержка нескольких методов доступа к камерам IMX219 на Raspberry Pi 5, чтобы решить проблемы с выводом изображения.

## Проблема

При использовании `rpi5_libcamera` бэкенда изображение не выводилось. Это могло быть связано с:
- Отсутствием GStreamer плагина libcamera
- Проблемами совместимости OpenCV с GStreamer
- Неправильной конфигурацией pipeline

## Решение

Добавлены три метода доступа к камерам с разными уровнями зависимостей:

### 1. Picamera2 (РЕКОМЕНДУЕТСЯ)
- **Бэкенд:** `rpi5_picamera2`
- **Преимущества:**
  - Нативная библиотека для Raspberry Pi
  - Лучшая производительность
  - Наиболее стабильная работа
  - Прямой доступ к libcamera без GStreamer
- **Зависимости:** `python3-picamera2` (системный пакет)

### 2. V4L2 Direct Access
- **Бэкенд:** `rpi5_v4l2`
- **Преимущества:**
  - Прямой доступ через `/dev/video*`
  - Не требует дополнительных плагинов GStreamer
  - Работает с OpenCV из коробки
- **Зависимости:** Только OpenCV с GStreamer support

### 3. libcamera через GStreamer (существующий)
- **Бэкенд:** `rpi5_libcamera`
- **Преимущества:**
  - Полный контроль через GStreamer pipeline
- **Зависимости:** `gstreamer1.0-libcamera`

## Измененные файлы

### 1. `app/services/jetson_camera_provider.py`
**Добавлено:**
- Импорт `Picamera2` (опциональный)
- Константы для новых бэкендов: `CAMERA_BACKEND_RPI5_PICAMERA2`, `CAMERA_BACKEND_RPI5_V4L2`
- Метод `_build_rpi5_v4l2_pipeline()` для V4L2 pipeline
- Метод `_open_picamera2()` для работы с Picamera2
- Логирование для диагностики проблем
- Поддержка RGB->BGR конвертации для Picamera2

**Изменено:**
- `_open_capture()` теперь поддерживает все три бэкенда
- `get_frame_bytes()` обрабатывает Picamera2 отдельно
- `close()` корректно закрывает Picamera2 камеры
- `_close_other_rpi5_captures()` закрывает как OpenCV, так и Picamera2 камеры

### 2. `app/core/settings.py`
**Изменено:**
- Валидация `camera_backend` теперь включает все четыре варианта
- Обновлен список допустимых значений

### 3. `README.md`
**Добавлено:**
- Секция "Диагностика камер"
- Три метода запуска с примерами команд
- Секция "Решение проблем с камерами на RPi 5"
- Обновлен список переменных окружения

### 4. `requirements.txt`
**Добавлено:**
- Комментарий о Picamera2 (устанавливается как системный пакет)

## Новые файлы

### 1. `test_rpi_cameras.py`
Диагностический скрипт для проверки всех методов доступа к камерам:
- Проверяет наличие Picamera2
- Тестирует libcamera tools (rpicam-vid, libcamera-hello)
- Проверяет OpenCV с GStreamer
- Тестирует V4L2 устройства
- Выдает рекомендации по оптимальному бэкенду

### 2. `RASPBERRY_PI_5_SETUP.md`
Подробное руководство по настройке:
- Пошаговая инструкция по настройке системы
- Установка зависимостей для каждого метода
- Примеры запуска
- Решение типичных проблем
- Настройка автозапуска через systemd
- Полезные команды для диагностики

### 3. `QUICK_START_RPI5.sh`
Bash-скрипт для быстрого запуска:
- Автоматическая проверка наличия камер
- Выбор бэкенда через аргумент командной строки
- Проверка зависимостей
- Автоматическая установка Python пакетов
- Запуск приложения с правильными настройками

## Использование

### Быстрый старт

```bash
# Метод 1: Использовать скрипт быстрого запуска
chmod +x QUICK_START_RPI5.sh
./QUICK_START_RPI5.sh picamera2

# Метод 2: Запустить диагностику, затем настроить вручную
python test_rpi_cameras.py
# Следуйте рекомендациям скрипта
```

### Ручная настройка

```bash
# Picamera2 (рекомендуется)
export CRAN_CAMERA_BACKEND=rpi5_picamera2
export CRAN_BRIDGE_CAMERA_DEVICE="0"
export CRAN_HOOK_CAMERA_DEVICE="1"
uvicorn main:app --host 0.0.0.0 --port 8000

# V4L2
export CRAN_CAMERA_BACKEND=rpi5_v4l2
export CRAN_BRIDGE_CAMERA_DEVICE="0"
export CRAN_HOOK_CAMERA_DEVICE="1"
uvicorn main:app --host 0.0.0.0 --port 8000

# libcamera (требует gstreamer1.0-libcamera)
export CRAN_CAMERA_BACKEND=rpi5_libcamera
export CRAN_BRIDGE_CAMERA_DEVICE="0"
export CRAN_HOOK_CAMERA_DEVICE="1"
uvicorn main:app --host 0.0.0.0 --port 8000
```

## Переменные окружения

| Переменная | Значения | По умолчанию | Описание |
|-----------|----------|--------------|----------|
| `CRAN_CAMERA_BACKEND` | `jetson`, `rpi5_picamera2`, `rpi5_libcamera`, `rpi5_v4l2` | `jetson` | Метод доступа к камерам |
| `CRAN_BRIDGE_CAMERA_DEVICE` | `0`, `1`, или путь | `0` | Индекс или путь камеры моста |
| `CRAN_HOOK_CAMERA_DEVICE` | `0`, `1`, или путь | `1` | Индекс или путь камеры крюка |
| `CRAN_RPI5_CAMERA_WIDTH` | число | `1920` | Ширина кадра |
| `CRAN_RPI5_CAMERA_HEIGHT` | число | `1080` | Высота кадра |
| `CRAN_RPI5_CAMERA_FRAMERATE` | `fps/1` | `10/1` | Частота кадров |

## Рекомендации

1. **Для Raspberry Pi 5:** Используйте `rpi5_picamera2` - это самый стабильный и производительный вариант
2. **Если Picamera2 недоступна:** Попробуйте `rpi5_v4l2` - не требует дополнительных плагинов
3. **Для максимального контроля:** Используйте `rpi5_libcamera` с кастомным GStreamer pipeline через `CRAN_BRIDGE_CAMERA_PIPELINE`

## Обратная совместимость

Все изменения полностью обратно совместимы:
- Jetson Nano продолжает работать с бэкендом `jetson`
- Существующие настройки `rpi5_libcamera` продолжают работать
- По умолчанию используется `jetson` бэкенд

## Тестирование

Для проверки работоспособности:

1. Запустите диагностический скрипт:
   ```bash
   python test_rpi_cameras.py
   ```

2. Проверьте, что камеры обнаруживаются:
   ```bash
   rpicam-vid --list-cameras
   ```

3. Запустите приложение с отладкой:
   ```bash
   uvicorn main:app --host 0.0.0.0 --port 8000 --log-level debug
   ```

4. Откройте веб-интерфейс и проверьте потоки с камер в разделах калибровки

## Решение проблем

См. подробное руководство в файлах:
- `RASPBERRY_PI_5_SETUP.md` - полная инструкция
- `README.md` - секция "Решение проблем с камерами на RPi 5"

Основные шаги:
1. Проверьте `/boot/firmware/config.txt`
2. Перезагрузите после изменений конфигурации
3. Запустите `test_rpi_cameras.py` для диагностики
4. Попробуйте разные бэкенды
5. Проверьте логи приложения
